<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http://www.magento.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
/**
 * @var $this Mage_Tax_Block_Checkout_Subtotal
 * @see Mage_Tax_Block_Checkout_Subtotal
 */

$_tollerace = 0.009;
$_totals = $this->getTotals();
$_hasZeroTax = ( $_totals['tax']->getData('value') <= $_tollerace );
$_summFreeTax = $this->getTotal()->getValueInclTax() - $this->getTotal()->getValueExclTax();
?>
<?php if ($this->displayBoth()):?>
<tr id="subtotal-excl-tax">
    <td style="<?php echo $this->getStyle() ?>" class="a-right subtotal-excl-tax subtotal-label" colspan="<?php echo $this->getColspan(); ?>">
        <?php echo $this->helper('tax')->__('Subtotal (Excl. Tax)') ?>
    </td>
    <td style="<?php echo $this->getStyle() ?>" class="a-right subtotal-excl-tax subtotal-value">
        <?php echo $this->helper('checkout')->formatPrice($this->getTotal()->getValueExclTax()) ?>
    </td>
</tr>
<tr id="subtotal-incl-tax">
    <td style="<?php echo $this->getStyle() ?>" class="a-right subtotal-incl-tax subtotal-label" colspan="<?php echo $this->getColspan(); ?>">
        <?php echo $this->helper('tax')->__('Subtotal (Incl. Tax)') ?>
    </td>
    <td style="<?php echo $this->getStyle() ?>" class="a-right subtotal-incl-tax subtotal-value">
        <?php echo $this->helper('checkout')->formatPrice($this->getTotal()->getValueInclTax()) ?>
    </td>
</tr>
    <?php if($_summFreeTax <= $_tollerace && $_hasZeroTax ): ?>
        <tr id="subtotal-free-tax">
            <td style="<?php echo $this->getStyle() ?>" class="a-right subtotal-free-tax subtotal-label" colspan="<?php echo $this->getColspan(); ?>">
                <?php echo $this->helper('tax')->__('Subtotal (Tax Free)'); ?>
            </td>
            <td style="<?php echo $this->getStyle() ?>" class="a-right subtotal-free-tax subtotal-value">
                <?php echo $this->helper('checkout')->formatPrice($_summFreeTax); ?>
            </td>
        </tr>
    <?php endif; ?>
<?php else : ?>
<tr id="subtotal-tax">
    <td style="<?php echo $this->getStyle() ?>" class="a-right subtotal-label" colspan="<?php echo $this->getColspan(); ?>">
      <?php if($_summFreeTax <= $_tollerace && $_hasZeroTax): ?>
          <?php echo $this->helper('tax')->__('Subtotal (Tax Free)'); ?>
      <?php elseif ( Mage::getStoreConfig('tax/cart_display/subtotal') == 1 ): ?>
        <?php echo $this->helper('tax')->__('Subtotal (Excl. Tax)') ?>
      <?php elseif ( Mage::getStoreConfig('tax/cart_display/subtotal') == 2 ): ?>
        <?php echo $this->helper('tax')->__('Subtotal (Incl. Tax)') ?>
      <?php else: ?>
        <?php echo $this->getTotal()->getTitle() ?>
      <?php endif; ?>
    </td>
    <td style="<?php echo $this->getStyle() ?>" class="a-right subtotal-value">
        <?php echo $this->helper('checkout')->formatPrice($this->getTotal()->getValue()) ?>
    </td>
</tr>
<?php endif;?>
