<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_default
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php

/**
 * @see Mage_Downloadable_Block_Adminhtml_Catalog_Product_Edit_Tab_Downloadable_Links
 * @var $this Dwd_ConfigurableDownloadable_Block_Adminhtml_Catalog_Product_Edit_Tab_Configdownloadable_Dynlinks
 */
?>
<?php $_product = $this->getProduct()?>
<div class="fieldset">
<table class="form-list">
    <tbody>
        <tr class="headings">
            <td class="label"><label for="name"><?php echo Mage::helper('downloadable')->__('Title')?></label>
            </td>
            <td class="value">
                <input type="text" class="input-text" id="downloadable_links_title" id="product[links_title]" value="<?php echo $_product->getId()?$_product->getLinksTitle():$this->getLinksTitle() ?>" <?php echo ($_product->getStoreId() && $this->getUsedDefault())?'disabled="disabled"':'' ?> />
            </td>
            <td class="scope-label"><?php if (!Mage::app()->isSingleStoreMode()): ?>[STORE VIEW]<?php endif; ?></td>
            <td class="value use-default">
            <?php if($_product->getStoreId()): ?>
                <input id="link_title_default" type="checkbox" id="use_default[]" value="links_title" onclick="toggleValueElements(this, this.parentNode.parentNode)" <?php echo $this->getUsedDefault()?'checked="checked"':'' ?> />
                <label class="normal" for="link_title_default"><?php echo Mage::helper('downloadable')->__('Use Default Value'); ?></label>
            <?php endif; ?>
            </td>
        </tr>
    </tbody>
</table>
<br />
<input type="hidden" class="" id="configdownloadable_link_purchase_type" id="product[links_purchased_separately]" value="0" />
<br />
<table class="form-list">
    <tbody>
        <tr class="headings">
            <td class="label">
            	<label for="configdownloadable_storage_time"><?php echo Mage::helper('configdownloadable')->__('Storage time')?> <span class="required">*</span></label>
            </td>
            <td class="value">
                <input type="text" class="item-qty validate-digits required-entry" id="configdownloadable_storage_time" id="product[storage_time]" value="<?php echo $_product->getId()?$_product->getStorageTime():$this->getStorageTime() ?>" <?php echo ($_product->getStoreId() && $this->getUsedDefaultStorageTime())?'disabled="disabled"':'' ?> />
                <p class="note"><?php echo $this->getStorageTimeNote()?></p>
            </td>
            <td class="scope-label"><?php if (!Mage::app()->isSingleStoreMode()): ?>[STORE VIEW]<?php endif; ?></td>
        </tr>
        <tr class="headings">
            <td class="label">
            	<label for="configdownloadable_replace_duplicates"><?php echo Mage::helper('configdownloadable')->__('Replace duplicates')?> <span class="required">*</span></label>
            </td>
            <td class="value">
                <?php echo $this->getReplaceDuplicatesSelect()?>
                <p class="note"><?php echo $this->getReplaceDuplicatesNote()?></p>
            </td>
            <td class="scope-label"><?php if (!Mage::app()->isSingleStoreMode()): ?>[STORE VIEW]<?php endif; ?></td>
        </tr>
    </tbody>
</table>
<br />
<div style="clear:both">
	<fieldset class="box-left" style="width:360px; margin-right:20px;">
		<div><strong><?php echo Mage::helper('configdownloadable')->__('Following placeholders are available:')?></strong></div>
		<table style="width:90%;">
			<tbody>
				<tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Station ID').": " ?></strong></td>
					<td><?php echo Dwd_ConfigurableDownloadable_Model_Link::PLACEHOLDER_STATION_ID ?></td>
				</tr>
				<tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Wildcard for any number of valid characters in file name').": " ?></strong></td>
					<td><?php echo '*' ?></td>
				</tr>
				<tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Wildcard for only one character in file name').": " ?></strong></td>
					<td><?php echo '?' ?></td>
				</tr>
			</tbody>
		</table>
	</fieldset>
	<fieldset style="width:360px;">
		<div><strong><?php echo Mage::helper('configdownloadable')->__('Following placeholders for periodes are available:')?></strong></div>
		<table style="width:90%;">
			<tbody>
				<tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Year').": " ?></strong></td>
					<td><?php echo Dwd_ConfigurableDownloadable_Model_Link::PLACEHOLDER_PERIODE_YEAR ?></td>
				</tr>
				<tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Short year').": "?></strong></td>
					<td><?php echo Dwd_ConfigurableDownloadable_Model_Link::PLACEHOLDER_PERIODE_YEAR_SHORT ?></td>
				</tr>
				<tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Month').": " ?></strong></td>
					<td><?php echo Dwd_ConfigurableDownloadable_Model_Link::PLACEHOLDER_PERIODE_MONTH ?></td>
				</tr>
				<tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Short month').": " ?></strong></td>
					<td><?php echo Dwd_ConfigurableDownloadable_Model_Link::PLACEHOLDER_PERIODE_MONTH_SHORT ?></td>
				</tr><tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Day').": " ?></strong></td>
					<td><?php echo Dwd_ConfigurableDownloadable_Model_Link::PLACEHOLDER_PERIODE_DAY ?></td>
				</tr><tr>
					<td><strong><?php echo Mage::helper('configdownloadable')->__('Short day').": " ?></strong></td>
					<td><?php echo Dwd_ConfigurableDownloadable_Model_Link::PLACEHOLDER_PERIODE_DAY_SHORT ?></td>
				</tr>
			</tbody>
		</table>
	</fieldset>
</div>
<div style="clear:both" />
<div class="grid">
<div class="hor-scroll">
<table class="data border">
    <col width="25%" />
    <col />
    <col />
    <col />
    <!-- Pattern -->
    <col width="25%"/>
    <col width="1" />
    <thead>
        <tr class="headings">
            <th><?php echo Mage::helper('downloadable')->__('Title')?> <span class="required">*</span></th>
            <?php if ($this->getCanReadPrice() !== false) : ?>
            	<th><?php echo Mage::helper('downloadable')->__('Price')?></th>
            <?php endif; ?>
            <th><span class="nobr"><?php echo Mage::helper('downloadable')->__('Max. Downloads')?></span></th>
            <th><?php echo Mage::helper('downloadable')->__('Shareable')?></th>
            <th><?php echo Mage::helper('configdownloadable')->__('Pattern')?></th>
            <th>&nbsp;</th>
        </tr>
    </thead>
    <tfoot>
        <tr>
            <td colspan="6" class="a-right"><?php echo $this->getAddButtonHtml()?></td>
        </tr>
    </tfoot>
    <tbody id="dynlink_items_body">
    </tbody>
</table>
<div><small><?php echo Mage::helper('downloadable')->__('Alphanumeric, dash and underscore characters are recommended for filenames. Improper characters are replaced with &rsquo;_&rsquo;.')?></small></div>
</div>
</div>
</div>

<script type="text/javascript">
//<![CDATA[
var linkTemplate = '<tr>'+
    '<td>'+
        '<input type="hidden" class="__delete__" id="configdownloadable[link][{{id}}][is_delete]" value="" />'+
        '<input type="hidden" id="configdownloadable[link][{{id}}][link_id]" value="{{link_id}}" />'+
        '<input type="text" class="required-entry input-text" id="configdownloadable[link][{{id}}][title]" value="{{title}}" />'+
        '<?php echo $_product->getStoreId()?'<input type="checkbox" id="configdownloadable_link_{{id}}_title" id="configdownloadable[link][{{id}}][use_default_title]" value="1" /><label class="normal" for="configdownloadable_link_{{id}}_title">Use Default Value</label>':'' ?>'+
    '</td>'+
    <?php if ($this->getCanReadPrice() !== false) : ?>
    '<td class="input-price">'+
        '<input type="text" id="configdownloadable_link_{{id}}_price_value" class="input-text validate-number link-prices<?php if ($this->getCanEditPrice() === false) : ?> disabled<?php endif; ?>" id="configdownloadable[link][{{id}}][price]" value="{{price}}"<?php if ($this->getCanEditPrice() === false) : ?> disabled="disabled"<?php endif; ?> /> ' +
        '<label>[<?php echo Mage::app()->getStore($_product->getStoreId())->getBaseCurrencyCode() ?>]</label>' +
        <?php if ($_product->getStoreId() && $this->getIsPriceWebsiteScope()) : ?>
        '<br /><input type="checkbox" id="configdownloadable_link_{{id}}_price" id="configdownloadable[link][{{id}}][use_default_price]" value="1"<?php if ($this->getCanEditPrice() === false) : ?> disabled="disabled"<?php endif; ?> /> <label for="configdownloadable_link_{{id}}_price"><?php echo Mage::helper('adminhtml')->__('Use Default Value')?></label>' +
        <?php endif; ?>
    '</td>' +
    <?php else : ?>
    '<input type="hidden" id="configdownloadable_link_{{id}}_price_value" class="link-prices" id="configdownloadable[link][{{id}}][price]" value="0" />' +
    <?php if ($_product->getStoreId() && $this->getIsPriceWebsiteScope()) : ?>
    '<input type="hidden" id="configdownloadable_link_{{id}}_price" id="configdownloadable[link][{{id}}][use_default_price]" value="1" />' +
    <?php endif; ?>
    <?php endif; ?>
    '<td><input type="text" id="configdownloadable_link_{{id}}_downloads" id="configdownloadable[link][{{id}}][number_of_downloads]" class="input-text downloads" value="{{number_of_downloads}}" />'+
    '<p><input type="checkbox" class="checkbox" id="configdownloadable_link_{{id}}_is_unlimited" id="configdownloadable[link][{{id}}][is_unlimited]" value="1" {{is_unlimited}} /> <label for="configdownloadable_link_{{id}}_is_unlimited"><?php echo Mage::helper('adminhtml')->__('Unlimited')?></label></p></td>'+
    '<td class="a-center">'+
        '<select id="configdownloadable_link _{{id}}_shareable" id="configdownloadable[link][{{id}}][is_shareable]">'+
            '<option value="1"><?php echo Mage::helper('downloadable')->__('Yes')?></option>'+
            '<option value="0"><?php echo Mage::helper('downloadable')->__('No')?></option>'+
            '<option value="2" selected="selected"><?php echo Mage::helper('downloadable')->__('Use config')?></option>'+
        '</select>'+
    '</td>'+
    '<td>'+
        '<div class="files">'+
            '<div class="row a-right">'+
                '<label for="configdownloadable_link_{{id}}_pattern_type" class="a-left"><input type="radio" class="radio validate-one-required-by-name" id="configdownloadable_link_{{id}}_pattern_type" id="configdownloadable[link][{{id}}][type]" value="pattern"{{pattern_checked}} /> <?php echo Mage::helper('configdownloadable')->__('Pattern'); ?> </label><input type="text" class="required-entry input-text" id="configdownloadable[link][{{id}}][link_pattern]" value="{{link_pattern}}" />'+
            '</div>'+
            '<div class="row">'+
            	'<p class="note"><?php echo Mage::helper('configdownloadable')->__("Don't use wildcards at the beginning of a schema!")?></p>'+
            '</div>'+
            '<div>'+
                '<span id="configdownloadable_link_{{id}}_link_container"></span>'+
            '</div>'+
        '</div>'+
    '</td>'+
    '<td>'+
        '<button id="configdownloadable_link_{{id}}_delete_button" type="button" class="scalable delete icon-btn delete-link-item"><span><?php echo Mage::helper('downloadable')->__('Delete'); ?></span></button>'+
    '</td>'+
'</tr>';

var linkItems = {
    tbody : $('dynlink_items_body'),
    templateSyntax : /(^|.|\r|\n)({{(\w+)}})/,
    templateText : linkTemplate,
    itemCount : 0,
    add : function(data) {
        alertAlreadyDisplayed = false;
        this.template = new Template(this.templateText, this.templateSyntax);

        if(!data.link_id){
            data = {};
            data.link_id  = 0;
            data.link_type = 'pattern';
            data.number_of_downloads = '<?php echo $this->getConfigMaxDownloads() ?>';
        }

        data.id = this.itemCount;

        if (data.link_type == 'url') {
            data.url_checked = ' checked="checked"';
        } else if (data.link_type == 'pattern') {
            data.pattern_checked = ' checked="checked"';
        }

        Element.insert(this.tbody, {'bottom':this.template.evaluate(data)});

        scopeTitle = $('configdownloadable_link_'+data.id+'_title');
        if (scopeTitle) {
            Event.observe(scopeTitle, 'click', function(event){
                scopeElm = $(Event.findElement(event, 'input'));
                titleField = scopeElm.up(0).down('input[type="text"]');
                if (scopeElm.checked == true) {
                    titleField.disabled = true;
                } else {
                    titleField.disabled = false;
                }
            });
        }
        if (!data.store_title && scopeTitle) {
            scopeTitle.up(0).down('input[type="text"]').disabled = true;
            scopeTitle.checked = true;
        }

        scopePrice = $('configdownloadable_link_'+data.id+'_price');
        if (scopePrice) {
            Event.observe(scopePrice, 'click', function(event){
                scopeElm = $(Event.findElement(event, 'input'));
                priceField = scopeElm.up(0).down('input[type="text"]');
                if (scopeElm.checked == true) {
                    priceField.disabled = true;
                } else {
                    priceField.disabled = false;
                }
            });
        }
        if (!data.website_price && scopePrice) {
            scopePrice.up(0).down('input[type="text"]').disabled = true;
            scopePrice.checked = true;
        }
        downloadsElm = $('configdownloadable_link_'+data.id+'_downloads');
        isUnlimitedElm = $('configdownloadable_link_'+data.id+'_is_unlimited');
        if (data.is_unlimited) {
            downloadsElm.disabled = true;
        }
        Event.observe(isUnlimitedElm, 'click', function(event){
            elm = Event.element(event);
            elm.up('td').down('input[type="text"].downloads').disabled = elm.checked;
        });

        if (data.is_shareable) {
            options = $('configdownloadable_link _'+data.id+'_shareable').options;
            for (var i=0; i < options.length; i++) {
                if (options[i].value == data.is_shareable) {
                    options[i].selected = true;
                }
            }
        }

        if (!data.file_save) {
            data.file_save = [];
        }

        linkPattern = $('configdownloadable_link_'+data.id+'_pattern_type');
        linkPattern.advaiceContainer = 'configdownloadable_link_'+data.id+'_link_container';

        this.itemCount++;
        this.togglePriceFields();
        this.bindRemoveButtons();
    },
    remove : function(event){
        var element = $(Event.findElement(event, 'tr'));
        alertAlreadyDisplayed = false;
        if(element){
            element.down('input[type="hidden"].__delete__').value = '1';
            Element.select(element, 'div.flex').each(function(elm){
                elm.remove();
            });
            element.addClassName('no-display');
            element.addClassName('ignore-validate');
            element.hide();
        }
    },
    bindRemoveButtons : function(){
        var buttons = $$('tbody#dynlink_items_body .delete-link-item');
        for(var i=0;i<buttons.length;i++){
            if(!$(buttons[i]).binded && !$(buttons[i]).hasClassName('disabled')){
                $(buttons[i]).binded = true;
                Event.observe(buttons[i], 'click', this.remove.bind(this));
            }
        }
    },
    togglePriceFields : function(){
        var toogleTo = $('configdownloadable_link_purchase_type').value;
        var disableFlag = true;
        if (toogleTo == '1') {
            disableFlag = false;
        }
        $$('.link-prices[type="text"]').each(function(elm){
            var flag = disableFlag;
            if (elm.hasClassName('disabled')) {
                flag = true;
            }
            elm.disabled = flag;
        });
    }
}

linkItems.bindRemoveButtons();

if ($('configdownloadable_link_purchase_type')) {
    Event.observe('configdownloadable_link_purchase_type', 'change', linkItems.togglePriceFields.bind());
}

if($('add_dynlink_item')) {
    Event.observe('add_dynlink_item', 'click', linkItems.add.bind(linkItems));
}

<?php foreach ($this->getLinkData() as $item): ?>
    linkItems.add(<?php echo $item->toJson()?>);
<?php endforeach; ?>

Validation.addAllThese([
    ['validate-downloadable-link-sample-file', 'Please specify File.', function(v,element) {
            fileSaveElm = element.up('div').next('input[type="hidden"]');
            if (element.checked && (fileSaveElm.value == '' || fileSaveElm.value == '[]')) {
                return false;
            }
            return true;
        }]
    ]);
Validation.addAllThese([
    ['validate-downloadable-link-sample-url', 'Please specify Sample URL.', function(v,element) {
            if (element.checked && element.up('p').down('input[type="text"]').value == '') {
                return false;
            }
            return true;
        }]
    ]);
//]]>
</script>
